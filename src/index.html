<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>hello phaser!</title>
    <script src="phaser.min.js"></script>
    <script src="path.js"></script>
  </head>
  <body>
  
  <script type="text/javascript">
  
  var map, layer, game;
  var t = 32;
  var w = 16,
      h = 16;
  var p_s = 8; // Player size
  var d_move = Phaser.Timer.SECOND*.25;
  
  window.onload = function() {
  
    game = new Phaser.Game(t*w, t*h, Phaser.AUTO, '', {
      preload: function () {
        this.stage.backgroundColor = '#c1bfec';
        
        this.load.image('player', 'sprite.png');
        this.load.image('tile', 'tile.png');
        this.load.tilemap('map', 'map.json', null, Phaser.Tilemap.TILED_JSON);
      },
      create: function () {
        map = this.add.tilemap('map');
        map.addTilesetImage('tile');
        layer = map.createLayer('Tile Layer 1');
        layer.resizeWorld();
        map.setCollisionBetween(0, 100);
        var player = this.add.sprite(t, t, 'player');
        
        window.p1 = player;
        
        var g = new SquareGrid(w, h);
        g.walls = extract_map(map);
        
        var start = map.objects['Object Layer 1'].filter(function(o){return o.name == 'start'})[0]
        start  = to_grid([start.x, start.y]);
        
        var goal = map.objects['Object Layer 1'].filter(function(o){return o.name == 'end'})[0]
        goal  = to_grid([goal.x, goal.y]);
        
        var parents = breadth_first_search(g, start);
        var path = find_path(parents, start, goal);
        
        start_path(path, player);
      },
      update: function () {
        
      }
    });
  };
  
  function start_path (path, p) {
    var start = path_pos(path, 0);
    p.x = start.x;
    p.y = start.y;
    
    p.pos = 0;
    move_player(path, p);
    game.time.events.repeat(d_move, path.length-1, function () { move_player(path, p) }, this);
  }
  
  function path_pos(path, index) {
    return {
      x: path[index][0]*t + (Math.random() * (t-p_s)),
      y: path[index][1]*t+ (Math.random() * (t-p_s))
    };
  }
  
  function move_player (path, p) {
    var pos = path_pos(path, p.pos);
    
    game.add.tween(p).to(pos, d_move, Phaser.Easing.Linear.None, true);
    
    var next = p.pos + 1;
    if (next >= path.length) {
      // Delete player
      console.log('Done')
      return;
    }
    p.pos = next;
  }
  
  function to_grid (p) {
    return p.map(function (v) {return Math.floor(v/t)});
  }
  
  function extract_map (map) {
    // Flatten map
    var tiles = [].concat.apply([], map.layer.data);
    
    // Just get walls
    tiles = tiles.filter(function(t) {
      return t.index !== -1;
    });
    
    // Get positions
    tiles = tiles.map(function (t) {
      return [t.x, t.y];
    });
    
    return tiles;
  }
  
  </script>
  
  </body>
</html>